library CrowdFundingInvoke

let one_msg = 
  fun (msg : Message) => 
    let nil_msg = Nil {Message} in
      Cons {Message} msg nil_msg

  
(***************************************************)
(*             The contract definition             *)
(***************************************************)
contract CrowdFundingInvoke

(*  Parameters *)
(cfaddr     : Address) (* address of the crowdfunding contract *)

(* Mutable fields *)
(* callers only keeps track of who all called Invoke. No real use *)
field callers : Map Address Int = Emp Address Int

transition Invoke (trans : String)
  bal <- balance;
  s = _sender;
  donate_s = "Donate";
  is_donate = builtin eq trans donate_s;
  match is_donate with
  | True =>
    msg = {_tag : Donate; _recipient : cfaddr; _amount : bal};
    msgs = one_msg msg;
    send msgs
  | False =>
    claimback_s = "ClaimBack";
    is_claimback = builtin eq trans claimback_s;
    match is_claimback with
    | True =>
      msg = {_tag : ClaimBack; _recipient : cfaddr; _amount : 0};
      msgs = one_msg msg;
      send msgs
    | False =>
      getfunds_s = "GetFunds";
      is_getfunds = builtin eq trans getfunds_s;
      match is_getfunds with
      | True =>
        msg = {_tag : GetFunds; _recipient : cfaddr; _amount : 0};
        msgs = one_msg msg;
        send msgs
      | False =>
        msg = {_tag : Main; _recipient : _sender ; _amount : 0};
        msgs = one_msg msg;
        send msgs
      end
    end
  end
end
